# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ —Ç–æ–º, –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ "–•–∞—á–∞–ø—É—Ä–∏ –ú–∞—Ä–∏–∫–æ" –º–æ–∂–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏: —Ä–∞—Å—Å—ã–ª–∫–∏, —Å—Ç–∞—Ç—É—Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –¥—Ä—É–≥–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π](#–æ–±–∑–æ—Ä-–º–µ—Ö–∞–Ω–∏–∑–º–æ–≤-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)
2. [Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è](#telegram-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)
3. [VK —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è](#vk-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)
4. [–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è](#—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ-–ø–æ–¥–ø–∏—Å–∫–∞–º–∏-–Ω–∞-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)
5. [–¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π](#—Ç–∏–ø—ã-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)
6. [–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫](#—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è-—Ä–∞—Å—Å—ã–ª–æ–∫)
7. [–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è](#—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è-–æ-—Å—Ç–∞—Ç—É—Å–µ-–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è)

---

## –û–±–∑–æ—Ä –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ –¥–≤–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã:

### 1. **Telegram Bot API**
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: Telegram –±–æ—Ç (`backend/bot/main-bot.cjs`)
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏: –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –ß–µ—Ä–µ–∑ `bot.telegram.sendMessage(chatId, message)`

### 2. **VK Bridge API**
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: VK Bridge –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (`frontend/src/lib/vkCore.ts`)
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏: –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤–Ω—É—Ç—Ä–∏ Mini App
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –ß–µ—Ä–µ–∑ `bridge.send("VKWebAppShowNotification", {...})`

### 3. **–í–Ω—É—Ç—Ä–∏–ø—Ä–∏–ª–æ–∂–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏: Toast-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –∞–ª–µ—Ä—Ç—ã, –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞

---

## Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

Telegram –±–æ—Ç —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º:

**–§–∞–π–ª:** `backend/bot/main-bot.cjs`

**–ü—Ä–∏–º–µ—Ä –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:**
```javascript
// –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
const sendWelcome = async (chatId, firstName) => {
  const message = [
    `üá¨üá™ –ì–∞–º–∞—Ä–¥–∂–æ–±–∞, ${firstName}! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ *–•–∞—á–∞–ø—É—Ä–∏ –ú–∞—Ä–∏–∫–æ*.`,
    "",
    "‚Ä¢ üìç –ù–∞–π—Ç–∏ –ª—é–±–æ–π –Ω–∞—à —Ä–µ—Å—Ç–æ—Ä–∞–Ω –≤ –≤–∞—à–µ–º –≥–æ—Ä–æ–¥–µ",
    "‚Ä¢ üìã –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–æ–ª–∏–∫",
    "‚Ä¢ üéÅ –£–∑–Ω–∞—Ç—å –æ–± –∞–∫—Ü–∏—è—Ö",
    "‚Ä¢ ‚≠ê –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤",
    "‚Ä¢ üöÄ –ó–∞–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É (—Å–∫–æ—Ä–æ)",
    "",
    "–ù–∞–∂–º–∏ –Ω–∞ ¬´–ù–∞—á–∞—Ç—å¬ª –∏ –±—É–¥—å –≤–∫—É—Å–Ω–æ –Ω–∞–∫–æ—Ä–º–ª–µ–Ω –≤—Å–µ–≥–¥–∞!",
  ].join("\n");

  await bot.telegram.sendMessage(chatId, message, {
    parse_mode: 'Markdown',
    disable_web_page_preview: true,
  });
};
```

### –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

#### 1. –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

```javascript
// backend/bot/main-bot.cjs

/**
 * –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
 */
async function sendBookingStatusNotification(telegramId, bookingData) {
  const chatId = Number(telegramId);
  
  const statusMessages = {
    created: "‚úÖ –í–∞—à–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ!",
    confirmed: "üéâ –í–∞—à–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ!",
    cancelled: "‚ùå –í–∞—à–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.",
  };

  const message = [
    statusMessages[bookingData.status] || "üìã –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ –≤–∞—à–µ–º—É –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—é",
    "",
    `üìÖ –î–∞—Ç–∞: ${bookingData.date}`,
    `üïê –í—Ä–µ–º—è: ${bookingData.time}`,
    `üë• –ì–æ—Å—Ç–µ–π: ${bookingData.guestsCount}`,
    `üçΩÔ∏è –†–µ—Å—Ç–æ—Ä–∞–Ω: ${bookingData.restaurantName}`,
    "",
    bookingData.comment || "",
  ].join("\n");

  try {
    await bot.telegram.sendMessage(chatId, message, {
      parse_mode: 'Markdown',
      disable_web_page_preview: true,
    });
    return true;
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:", error);
    return false;
  }
}

/**
 * –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
 */
async function sendBroadcast(message, filters = {}) {
  // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –ë–î
  const users = await query(`
    SELECT telegram_id 
    FROM user_profiles 
    WHERE notifications_enabled = true
    AND telegram_id IS NOT NULL
  `);

  let sent = 0;
  let failed = 0;

  for (const user of users.rows) {
    try {
      await bot.telegram.sendMessage(
        Number(user.telegram_id),
        message,
        { parse_mode: 'Markdown' }
      );
      sent++;
      // –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏ (—á—Ç–æ–±—ã –Ω–µ –ø—Ä–µ–≤—ã—Å–∏—Ç—å –ª–∏–º–∏—Ç—ã API)
      await new Promise(resolve => setTimeout(resolve, 50));
    } catch (error) {
      failed++;
      console.error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${user.telegram_id}:`, error);
    }
  }

  return { sent, failed, total: users.rows.length };
}
```

#### 2. –î–æ–±–∞–≤–∏—Ç—å API endpoint –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

```javascript
// backend/server/routes/notificationsRoutes.mjs

import express from "express";
import { query } from "../postgresClient.mjs";

export function createNotificationsRouter() {
  const router = express.Router();

  /**
   * POST /api/notifications/booking-status
   * –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
   */
  router.post("/booking-status", async (req, res) => {
    const { userId, bookingId, status } = req.body;

    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑ –ë–î
    const user = await queryOne(
      `SELECT telegram_id FROM user_profiles WHERE id = $1`,
      [userId]
    );

    const booking = await queryOne(
      `SELECT * FROM bookings WHERE id = $1`,
      [bookingId]
    );

    if (!user?.telegram_id) {
      return res.status(400).json({
        success: false,
        error: "–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç Telegram ID"
      });
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞
    // (–Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å HTTP API –≤ –±–æ—Ç –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—â—É—é –ë–î)
    
    return res.json({ success: true });
  });

  return router;
}
```

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è Telegram Bot API

- **–õ–∏–º–∏—Ç:** 30 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–µ–∫—É–Ω–¥—É –¥–ª—è –æ–¥–Ω–æ–≥–æ –±–æ—Ç–∞
- **–†–∞—Å—Å—ã–ª–∫–∏:** –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∏ –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏
- **–°–ø–∞–º:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞, –µ—Å–ª–∏ –ø–æ–ª—É—á–∞—é—Ç —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π

---

## VK —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

VK Bridge API –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:

**–§–∞–π–ª:** `frontend/src/lib/vkCore.ts`

### –ú–µ—Ç–æ–¥—ã VK Bridge –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

#### 1. –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ Mini App

```typescript
import bridge from "@vkontakte/vk-bridge";

/**
 * –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ VK Mini App
 */
async function showVKNotification(message: string, type: 'info' | 'success' | 'error' = 'info') {
  if (!isBridgeAvailable()) {
    // Fallback –Ω–∞ –æ–±—ã—á–Ω—ã–π alert
    alert(message);
    return;
  }

  try {
    await bridge.send("VKWebAppShowNotification", {
      text: message,
      type: type, // 'info' | 'success' | 'error'
    });
  } catch (error) {
    console.warn("[vk] showNotification failed", error);
    alert(message);
  }
}
```

#### 2. –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç—É (–¥–ª—è —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)

```typescript
import { safeSendData } from "@/lib/vk";

/**
 * –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É —á–µ—Ä–µ–∑ VK
 * –≠—Ç–æ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–∞ —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
 */
function sendDataToBot(data: { type: string; payload: unknown }) {
  safeSendData(JSON.stringify(data));
}
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ vkCore.ts

```typescript
// frontend/src/lib/vkCore.ts

import bridge from "@vkontakte/vk-bridge";

/**
 * –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ VK Mini App
 */
export const showNotification = async (
  text: string,
  options?: {
    type?: 'info' | 'success' | 'error';
    duration?: number;
  }
): Promise<boolean> => {
  if (!isBridgeAvailable()) {
    // Fallback –Ω–∞ –æ–±—ã—á–Ω—ã–π alert
    alert(text);
    return false;
  }

  try {
    await bridge.send("VKWebAppShowNotification", {
      text,
      type: options?.type || 'info',
    });
    return true;
  } catch (error) {
    console.warn("[vk] showNotification failed", error);
    alert(text);
    return false;
  }
};
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö

```typescript
import { showNotification } from "@/lib/vk";

// –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
await showNotification("‚úÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ!", {
  type: 'success',
});

// –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
await showNotification("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ", {
  type: 'error',
});
```

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è VK —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

- **–¢–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Mini App:** –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
- **–ù–µ—Ç push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:** VK –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç API –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- **–î–ª—è —Ä–∞—Å—Å—ã–ª–æ–∫:** –ù—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å VK API –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ

---

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

–í –ø—Ä–æ—Ñ–∏–ª–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å –ø–æ–ª–µ `notificationsEnabled`:

**–¢–∞–±–ª–∏—Ü–∞ –ë–î:** `user_profiles.notifications_enabled` (BOOLEAN DEFAULT true)

**–¢–∏–ø:** `frontend/src/shared/types/profile.ts`

```typescript
type UserProfile = {
  // ...
  notificationsEnabled: boolean;
};
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

#### Telegram

```typescript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ initData
const initData = getInitDataUnsafe();
const areNotificationsEnabled = initData?.user?.allows_write_to_pm === true;
```

#### VK

```typescript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ initData
const initData = getInitData();
const areNotificationsEnabled = initData?.vk_are_notifications_enabled === '1';
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

```typescript
// frontend/src/features/profile/edit/EditProfile.tsx

const handleNotificationsToggle = async (enabled: boolean) => {
  await updateProfile({
    notificationsEnabled: enabled,
  });
};
```

---

## –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### 1. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏

#### –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
```typescript
// –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
if (platform === 'telegram') {
  // –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Telegram Bot API
  await sendTelegramNotification(userTelegramId, {
    type: 'booking_created',
    booking: bookingData,
  });
} else if (platform === 'vk') {
  // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Mini App
  await showNotification("‚úÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ!", { type: 'success' });
}
```

#### –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
```typescript
// –ö–æ–≥–¥–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
async function notifyBookingStatusChange(bookingId: string, newStatus: string) {
  const booking = await getBooking(bookingId);
  const user = await getUserProfile(booking.userId);

  if (user.notificationsEnabled) {
    if (user.telegramId) {
      await sendTelegramNotification(user.telegramId, {
        type: 'booking_status_changed',
        booking: booking,
        newStatus: newStatus,
      });
    }
    
    // VK —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
    // –î–ª—è push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å VK API —Å–æ–æ–±—â–µ—Å—Ç–≤
  }
}
```

### 2. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–∫–∞–∑–∞—Ö

```typescript
// –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞
async function notifyOrderCreated(orderId: string) {
  const order = await getOrder(orderId);
  const user = await getUserProfile(order.userId);

  const message = [
    "üõí –í–∞—à –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç!",
    "",
    `–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: #${order.id}`,
    `–°—É–º–º–∞: ${order.total} ‚ÇΩ`,
    "",
    "–û–∂–∏–¥–∞–π—Ç–µ –∑–≤–æ–Ω–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.",
  ].join("\n");

  if (user.telegramId && user.notificationsEnabled) {
    await sendTelegramNotification(user.telegramId, message);
  }
}
```

### 3. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∞–∫—Ü–∏—è—Ö

```typescript
// –†–∞—Å—Å—ã–ª–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–∫—Ü–∏–∏
async function notifyPromotion(promotionId: string) {
  const promotion = await getPromotion(promotionId);
  
  const message = [
    "üéÅ –ù–æ–≤–∞—è –∞–∫—Ü–∏—è!",
    "",
    promotion.title,
    promotion.description,
    "",
    `–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: ${promotion.endDate}`,
  ].join("\n");

  // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤—Å–µ–º –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
  await sendBroadcast(message, {
    notificationsEnabled: true,
    cityId: promotion.cityId, // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≥–æ—Ä–æ–¥—É
  });
}
```

### 4. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö –æ—Ç–∑—ã–≤–∞—Ö (–¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤)

```typescript
// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –æ –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ–º –æ—Ç–∑—ã–≤–µ
async function notifyManagerAboutNegativeReview(review: ReviewData) {
  const managers = await getManagersForRestaurant(review.restaurantId);

  const message = [
    "‚ö†Ô∏è –ù–µ–≥–∞—Ç–∏–≤–Ω—ã–π –æ—Ç–∑—ã–≤",
    "",
    `–†–µ—Å—Ç–æ—Ä–∞–Ω: ${review.restaurant}`,
    `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${review.userName} (${review.userPhone})`,
    `–û—Ü–µ–Ω–∫–∞: ${review.rating}/5`,
    "",
    `–û—Ç–∑—ã–≤: ${review.text}`,
  ].join("\n");

  for (const manager of managers) {
    if (manager.telegramId) {
      await sendTelegramNotification(manager.telegramId, message, {
        reply_markup: {
          inline_keyboard: [[
            { text: "–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ", callback_data: `review_processed_${review.id}` },
            { text: "–¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è", callback_data: `review_attention_${review.id}` },
          ]],
        },
      });
    }
  }
}
```

---

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–∞—Å—Å—ã–ª–æ–∫

–î–ª—è –º–∞—Å—Å–æ–≤—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á:

```javascript
// backend/server/services/broadcastService.mjs

import { query, queryMany } from "../postgresClient.mjs";

/**
 * –°–µ—Ä–≤–∏—Å –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫
 */
export class BroadcastService {
  /**
   * –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
   */
  async sendBroadcast(message, options = {}) {
    const {
      notificationsEnabled = true,
      cityId = null,
      restaurantId = null,
      platform = null, // 'telegram' | 'vk' | null (–≤—Å–µ)
    } = options;

    // –§–æ—Ä–º–∏—Ä—É–µ–º SQL –∑–∞–ø—Ä–æ—Å —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
    let sql = `
      SELECT 
        id,
        telegram_id,
        vk_id,
        name,
        phone
      FROM user_profiles
      WHERE notifications_enabled = $1
    `;

    const params = [notificationsEnabled];
    let paramIndex = 2;

    if (cityId) {
      sql += ` AND favorite_city_id = $${paramIndex++}`;
      params.push(cityId);
    }

    if (restaurantId) {
      sql += ` AND favorite_restaurant_id = $${paramIndex++}`;
      params.push(restaurantId);
    }

    const users = await queryMany(sql, params);

    const results = {
      total: users.length,
      sent: 0,
      failed: 0,
      errors: [],
    };

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
    for (const user of users) {
      try {
        if (platform === 'telegram' || !platform) {
          if (user.telegram_id) {
            await this.sendTelegramMessage(user.telegram_id, message);
            results.sent++;
            await this.delay(50); // 50ms –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
          }
        }

        if (platform === 'vk' || !platform) {
          // –î–ª—è VK –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å VK API —Å–æ–æ–±—â–µ—Å—Ç–≤
          // –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —á–µ—Ä–µ–∑ –±–æ—Ç–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞
          // –≠—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        }
      } catch (error) {
        results.failed++;
        results.errors.push({
          userId: user.id,
          error: error.message,
        });
      }
    }

    return results;
  }

  /**
   * –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram Bot API
   */
  async sendTelegramMessage(telegramId, message) {
    // –ó–¥–µ—Å—å –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTTP API –±–æ—Ç–∞ –∏–ª–∏ –æ–±—â—É—é –ë–î
    // –î–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å HTTP endpoint –≤ –±–æ—Ç
    throw new Error("Not implemented: –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å HTTP API –≤ –±–æ—Ç");
  }

  delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ HTTP API –≤ –±–æ—Ç –¥–ª—è —Ä–∞—Å—Å—ã–ª–æ–∫

```javascript
// backend/bot/main-bot.cjs

// –î–æ–±–∞–≤–∏—Ç—å Express endpoint –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
app.post('/api/send-message', async (req, res) => {
  const { telegramId, message, options = {} } = req.body;

  if (!telegramId || !message) {
    return res.status(400).json({
      success: false,
      error: '–ù–µ–æ–±—Ö–æ–¥–∏–º—ã telegramId –∏ message'
    });
  }

  try {
    await bot.telegram.sendMessage(
      Number(telegramId),
      message,
      {
        parse_mode: options.parse_mode || 'Markdown',
        disable_web_page_preview: options.disable_web_page_preview !== false,
        ...options.reply_markup && { reply_markup: options.reply_markup },
      }
    );

    return res.json({ success: true });
  } catch (error) {
    return res.status(500).json({
      success: false,
      error: error.message
    });
  }
});
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–æ–∫

```typescript
// frontend/src/shared/api/broadcastApi.ts

export async function sendBroadcast(
  message: string,
  filters: {
    cityId?: string;
    restaurantId?: string;
    platform?: 'telegram' | 'vk';
  }
) {
  const response = await fetch(`${API_URL}/api/admin/broadcast`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      // –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∞–¥–º–∏–Ω–∞
    },
    body: JSON.stringify({
      message,
      ...filters,
    }),
  });

  return response.json();
}
```

---

## –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

### –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–∑–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ Remarked API –∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î:

**–§–∞–π–ª:** `backend/server/routes/bookingRoutes.mjs`

**–¢–∞–±–ª–∏—Ü–∞:** `bookings` —Å –ø–æ–ª–µ–º `status` ('created' | 'confirmed' | 'cancelled')

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Å—Ç–∞—Ç—É—Å–µ

#### 1. Webhook –æ—Ç Remarked (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)

```javascript
// backend/server/routes/bookingRoutes.mjs

/**
 * POST /api/booking/webhook
 * Webhook –æ—Ç Remarked –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
 */
router.post("/webhook", async (req, res) => {
  const { reserve_id, status, ...otherData } = req.body;

  // –ù–∞—Ö–æ–¥–∏–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ë–î
  const booking = await queryOne(
    `SELECT * FROM bookings WHERE remarked_reserve_id = $1`,
    [reserve_id]
  );

  if (!booking) {
    return res.status(404).json({ success: false });
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –ë–î
  await query(
    `UPDATE bookings SET status = $1, updated_at = NOW() WHERE id = $2`,
    [status, booking.id]
  );

  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
  await notifyBookingStatusChange(booking, status);

  return res.json({ success: true });
});
```

#### 2. –§—É–Ω–∫—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

```javascript
// backend/server/services/notificationService.mjs

import { queryOne } from "../postgresClient.mjs";

/**
 * –£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
 */
export async function notifyBookingStatusChange(booking, newStatus) {
  // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const user = await queryOne(
    `SELECT telegram_id, vk_id, notifications_enabled, name 
     FROM user_profiles 
     WHERE id = $1 OR phone = $2`,
    [booking.userId, booking.customer_phone]
  );

  if (!user || !user.notifications_enabled) {
    return;
  }

  const statusMessages = {
    created: "‚úÖ –í–∞—à–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ!",
    confirmed: "üéâ –í–∞—à–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ!",
    cancelled: "‚ùå –í–∞—à–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.",
  };

  const message = [
    statusMessages[newStatus] || "üìã –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ –≤–∞—à–µ–º—É –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—é",
    "",
    `üìÖ –î–∞—Ç–∞: ${booking.booking_date}`,
    `üïê –í—Ä–µ–º—è: ${booking.booking_time}`,
    `üë• –ì–æ—Å—Ç–µ–π: ${booking.guests_count}`,
    `üçΩÔ∏è –†–µ—Å—Ç–æ—Ä–∞–Ω: ${booking.restaurant_name || '–†–µ—Å—Ç–æ—Ä–∞–Ω'}`,
  ].join("\n");

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Telegram
  if (user.telegram_id) {
    await sendTelegramNotification(user.telegram_id, message);
  }

  // –î–ª—è VK –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å VK API —Å–æ–æ–±—â–µ—Å—Ç–≤ –¥–ª—è push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  // –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —á–µ—Ä–µ–∑ –±–æ—Ç–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞
}
```

#### 3. –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```javascript
// backend/server/services/bookingStatusChecker.mjs

/**
 * –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –≤ Remarked
 * –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)
 */
export async function checkBookingStatuses() {
  // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
  const bookings = await queryMany(`
    SELECT * FROM bookings 
    WHERE status IN ('created', 'confirmed')
    AND booking_date >= CURRENT_DATE
  `);

  for (const booking of bookings) {
    try {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ Remarked
      const status = await checkRemarkedStatus(booking.remarked_reserve_id);
      
      if (status !== booking.status) {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏ —É–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        await query(
          `UPDATE bookings SET status = $1 WHERE id = $2`,
          [status, booking.id]
        );
        await notifyBookingStatusChange(booking, status);
      }
    } catch (error) {
      console.error(`–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ${booking.id}:`, error);
    }
  }
}
```

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 1. –°–æ–∑–¥–∞—Ç—å –µ–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

```typescript
// backend/server/services/notificationService.mjs

export class NotificationService {
  async send(recipient: {
    userId: string;
    telegramId?: number;
    vkId?: number;
  }, notification: {
    type: string;
    title: string;
    message: string;
    data?: unknown;
  }) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const user = await getUserProfile(recipient.userId);
    if (!user.notificationsEnabled) {
      return { sent: false, reason: 'notifications_disabled' };
    }

    const results = {
      telegram: false,
      vk: false,
    };

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Telegram
    if (recipient.telegramId) {
      try {
        await this.sendTelegram(recipient.telegramId, notification);
        results.telegram = true;
      } catch (error) {
        console.error('Telegram notification failed:', error);
      }
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ VK (—Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ VK API)
    if (recipient.vkId) {
      try {
        await this.sendVK(recipient.vkId, notification);
        results.vk = true;
      } catch (error) {
        console.error('VK notification failed:', error);
      }
    }

    return results;
  }

  async sendTelegram(telegramId: number, notification: Notification) {
    // HTTP –∑–∞–ø—Ä–æ—Å –∫ –±–æ—Ç—É –∏–ª–∏ –ø—Ä—è–º–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Bot API
  }

  async sendVK(vkId: number, notification: Notification) {
    // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ VK API –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ
  }
}
```

### 2. –î–æ–±–∞–≤–∏—Ç—å –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á –¥–ª—è —Ä–∞—Å—Å—ã–ª–æ–∫

–î–ª—è –±–æ–ª—å—à–∏—Ö —Ä–∞—Å—Å—ã–ª–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—á–µ—Ä–µ–¥—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, Bull –∏–ª–∏ BullMQ):

```javascript
// backend/server/queues/broadcastQueue.mjs

import Queue from 'bull';

const broadcastQueue = new Queue('broadcast', {
  redis: { host: 'localhost', port: 6379 }
});

broadcastQueue.process(async (job) => {
  const { message, userId, platform } = job.data;
  
  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
  await sendNotification(userId, message, platform);
});

export { broadcastQueue };
```

### 3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

```javascript
// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –ë–î
await query(`
  INSERT INTO notification_logs (
    user_id,
    type,
    platform,
    message,
    status,
    sent_at
  ) VALUES ($1, $2, $3, $4, $5, NOW())
`, [userId, type, platform, message, status]);
```

---

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### Telegram

- ‚úÖ **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:** Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –≤—ã—Å–æ–∫–∞—è –¥–æ—Å—Ç–∞–≤–ª—è–µ–º–æ—Å—Ç—å
- ‚ö†Ô∏è **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:** –õ–∏–º–∏—Ç 30 —Å–æ–æ–±—â–µ–Ω–∏–π/—Å–µ–∫, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞
- üí° **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∏ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏, —É–≤–∞–∂–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### VK

- ‚úÖ **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π VK
- ‚ö†Ô∏è **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:** –ù–µ—Ç push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –Ω—É–∂–µ–Ω –¥–æ—Å—Ç—É–ø –∫ VK API —Å–æ–æ–±—â–µ—Å—Ç–≤
- üí° **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å VK API –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ, –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ Mini App

### –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ** `notificationsEnabled` –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
2. **–õ–æ–≥–∏—Ä—É–π—Ç–µ** –≤—Å–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
3. **–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –æ—à–∏–±–∫–∏** gracefully
4. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—á–µ—Ä–µ–¥–∏** –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫
5. **–£–≤–∞–∂–∞–π—Ç–µ –ª–∏–º–∏—Ç—ã** API –ø–ª–∞—Ç—Ñ–æ—Ä–º
6. **–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º** –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Telegram Bot API Documentation](https://core.telegram.org/bots/api)
- [VK Bridge API Documentation](https://dev.vk.com/ru/bridge/overview)
- [VK Mini Apps Guide](https://dev.vk.com/ru/mini-apps/overview)
- [VK API –¥–ª—è —Å–æ–æ–±—â–µ—Å—Ç–≤](https://dev.vk.com/ru/api/community)

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2024
